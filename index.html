<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2025 Content Dashboard (CSV)</title>

  <!-- DataTables (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.1.8/css/dataTables.dataTables.min.css">
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111826;
      --panel2:#0f1722;
      --border:#233043;
      --text:#e6edf7;
      --muted:#9fb0c6;
      --link:#6ea8ff;
      --btn:#e6edf7;
      --btnText:#0b0f14;
      --btnBorder:#e6edf7;
      --inputBg:#0b1220;
      --inputBorder:#2a3a52;
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Thai", sans-serif;
      margin: 24px;
      background: var(--bg);
      color: var(--text);
    }

    h1{ font-size:18px; margin:0 0 12px; color: var(--text); }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin: 12px 0 16px;
    }

    .card{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: var(--panel);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.15) inset;
    }

    .card .label{ font-size:12px; color: var(--muted); }
    .card .value{ font-size:22px; font-weight:700; margin-top:6px; color: var(--text); }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:flex-end;
      margin: 10px 0 16px;
    }

    .controls label{ font-size:12px; color: var(--muted); display:block; margin-bottom:6px; }

    .controls select,
    .controls input{
      padding: 8px 10px;
      border: 1px solid var(--inputBorder);
      border-radius: 10px;
      min-width: 220px;
      background: var(--inputBg);
      color: var(--text);
      outline: none;
    }
    .controls select:focus,
    .controls input:focus{
      border-color: #3a5d88;
      box-shadow: 0 0 0 3px rgba(110,168,255,0.15);
    }

    .controls button{
      padding: 9px 12px;
      border-radius: 10px;
      border: 1px solid var(--btnBorder);
      background: transparent;
      color: var(--btn);
      cursor:pointer;
    }

    .controls button.secondary{
      background: transparent;
      color: var(--btn);
      border: 1px solid var(--btnBorder);
    }

    .small{ font-size:12px; color: var(--muted); margin-top:6px; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; color: var(--muted); }
    a{ color: var(--link); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* DataTables dark overrides */
    table.dataTable{
      border: 1px solid var(--border) !important;
      border-radius: 12px;
      overflow: hidden;
      background: var(--panel);
      color: var(--text);
    }
    table.dataTable thead th{
      background: var(--panel2) !important;
      color: var(--text) !important;
      border-bottom: 1px solid var(--border) !important;
    }
    table.dataTable tbody td{
      vertical-align: top;
      border-bottom: 1px solid rgba(35,48,67,0.6) !important;
      color: var(--text);
    }
    table.dataTable tbody tr{
      background: var(--panel) !important;
    }
    table.dataTable tbody tr:hover{
      background: rgba(110,168,255,0.08) !important;
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate{
      color: var(--muted) !important;
    }

    .dataTables_wrapper .dataTables_filter input,
    .dataTables_wrapper .dataTables_length select{
      background: var(--inputBg) !important;
      color: var(--text) !important;
      border: 1px solid var(--inputBorder) !important;
      border-radius: 10px !important;
      padding: 6px 8px !important;
      outline: none;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button{
      color: var(--text) !important;
      border: 1px solid var(--border) !important;
      background: transparent !important;
      border-radius: 10px !important;
      margin-left: 6px !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current{
      background: rgba(110,168,255,0.18) !important;
      border-color: rgba(110,168,255,0.35) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover{
      background: rgba(110,168,255,0.10) !important;
      border-color: rgba(110,168,255,0.35) !important;
    }

    /* Make horizontal scroll (if any) blend in */
    .dataTables_scrollBody{
      border-top: 1px solid var(--border) !important;
    }
  
    /* Month tabs */
    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin: 14px 0 10px;
      align-items:center;
    }
    .tab{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      user-select:none;
    }
    .tab:hover{
      border-color: rgba(110,168,255,0.45);
      background: rgba(110,168,255,0.08);
    }
    .tab.active{
      border-color: rgba(110,168,255,0.55);
      background: rgba(110,168,255,0.18);
    }
    .tabs .hint{
      font-size: 12px;
      color: var(--muted);
      margin-right: 6px;
    }
    /* Charts */
    #reportsArea canvas{ max-width: 100%; }


  </style>
</head>
<body>
  <h1>Dashboard: Annual Report CSV (‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏û‡∏™‡∏ï‡πå + ‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á)</h1>
  <div class="small">
    ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Üí ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‚Üí ‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ñ‡∏≤‡∏ß‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á
  </div>


  <div class="tabs" id="monthTabs" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô">
    <span class="hint">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</span>
    <button class="tab active" type="button" data-month="all">‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ</button>
    <button class="tab" type="button" data-month="0">‡∏°.‡∏Ñ.</button>
    <button class="tab" type="button" data-month="1">‡∏Å.‡∏û.</button>
    <button class="tab" type="button" data-month="2">‡∏°‡∏µ.‡∏Ñ.</button>
    <button class="tab" type="button" data-month="3">‡πÄ‡∏°.‡∏¢.</button>
    <button class="tab" type="button" data-month="4">‡∏û.‡∏Ñ.</button>
    <button class="tab" type="button" data-month="5">‡∏°‡∏¥.‡∏¢.</button>
    <button class="tab" type="button" data-month="6">‡∏Å.‡∏Ñ.</button>
    <button class="tab" type="button" data-month="7">‡∏™.‡∏Ñ.</button>
    <button class="tab" type="button" data-month="8">‡∏Å.‡∏¢.</button>
    <button class="tab" type="button" data-month="9">‡∏ï.‡∏Ñ.</button>
    <button class="tab" type="button" data-month="10">‡∏û.‡∏¢.</button>
    <button class="tab" type="button" data-month="11">‡∏ò.‡∏Ñ.</button>
  </div>



  <div class="controls">
    <div>
      <label>1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</label>
      <input id="fileInput" type="file" accept=".csv" />
    </div>

    <div>
      <label>2) ‡∏õ‡∏µ</label>
      <select id="yearFilter">
        <option value="2025">2025</option>
        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      </select>
    </div>

    <div>
      <label>3) ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
      <input id="searchBox" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô tax, forum, training..." />
    </div>

    <button id="resetBtn" class="secondary" type="button">Reset Filters</button>
    <button id="compareBtn" class="secondary" type="button">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
    <button id="pieBtn" class="secondary" type="button">ü•ß Pie ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
  </div>

  <div class="grid">
    <div class="card">
      <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå (‡∏´‡∏•‡∏±‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå)</div>
      <div class="value" id="kpiPosts">-</div>
    </div>
    <div class="card">
      <div class="label">Average Engagement / Post (Like+Share)</div>
      <div class="value" id="kpiAvgEng">-</div>
    </div>
    <div class="card">
      <div class="label">Top Engagement (Like+Share)</div>
      <div class="value" id="kpiTopEng">-</div>
    </div>
  
</div>

  <!-- Reports (Data Visualization) -->
  <section id="reportsArea" style="margin: 8px 0 14px;">
    <div id="monthlyCharts" class="card" style="display:none;">
      <div class="label" id="momTitle">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ï‡∏≤‡∏°‡∏õ‡∏µ + ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô) ‚Äî Posts / Views / Like / Share / Comment</div>
      <div class="small">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Comment ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
      <div style="margin-top:10px;">
        <canvas id="momChart" height="120"></canvas>
      </div>
    </div>

    <div id="pieCharts" style="display:none; margin-top:12px;">
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr; margin-top:0;">
        <div class="card">
          <div class="label">Pie ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ: Content (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div>
          <div style="margin-top:10px;"><canvas id="pieContent" height="160"></canvas></div>
        </div>
        <div class="card">
          <div class="label">Pie ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ: Impression (‡πÉ‡∏ä‡πâ Impressions ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ / ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡πÉ‡∏ä‡πâ Reach)</div>
          <div style="margin-top:10px;"><canvas id="pieImpr" height="160"></canvas></div>
        </div>
        <div class="card">
          <div class="label">Pie ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ: Engage (Like+Share+Comment)</div>
          <div style="margin-top:10px;"><canvas id="pieEng" height="160"></canvas></div>
        </div>
      </div>
      <div class="small">Tooltip ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á Total ‡πÅ‡∏•‡∏∞ Avg/Post ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
    </div>
  </section>

  <table id="postsTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏û‡∏™‡∏ï‡πå</th>
        <th>Like</th>
        <th>Share</th>
        <th>Engagement</th>
        <th>Reach</th>
        <th>Views</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net@2.1.8/js/dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // ====== Column names (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏ß‡∏° ‡πÜ) ======
    const COLCAND = {
      title: ["‡∏ä‡∏∑‡πà‡∏≠", "Title", "Post title", "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏û‡∏™‡∏ï‡πå", "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°", "Message"],
      publishedAt: ["‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà", "Published At", "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà", "Timestamp", "Date", "Datetime"],
      permalink: ["‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ñ‡∏≤‡∏ß‡∏£", "Permalink", "Link", "URL", "‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ñ‡∏≤‡∏ß‡∏£"],
      reach: ["‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á", "Reach"],
      views: ["‡∏¢‡∏≠‡∏î‡∏î‡∏π", "Views", "View"],
      like: ["‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å", "Like", "Likes"],
      share: ["‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå", "Share", "Shares"],
      comment: ["‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô", "‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå", "Comment", "Comments"],
      impressions: ["‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•", "Impression", "Impressions"]
    };

    let COL = {
      title: null,
      publishedAt: null,
      permalink: null,
      reach: null,
      views: null,
      like: null,
      share: null,
      comment: null,
      impressions: null
    };

    let rawRows = [];
    let table = null;

    // Charts
    let momChart = null;
    let pieContent = null;
    let pieImpr = null;
    let pieEng = null;

    const fileInput = document.getElementById("fileInput");
    const yearFilter = document.getElementById("yearFilter");
    const searchBox = document.getElementById("searchBox");
    const resetBtn = document.getElementById("resetBtn");
    const compareBtn = document.getElementById("compareBtn");
    const pieBtn = document.getElementById("pieBtn");

    const monthTabs = document.getElementById("monthTabs");
    let monthVal = "all";

    const monthlyChartsEl = document.getElementById("monthlyCharts");
    const pieChartsEl = document.getElementById("pieCharts");

    // ---------- Utilities ----------
    function detectFirst(fields, candidates){
      if (!fields || !fields.length) return null;
      const set = new Set(fields);
      for (const c of candidates){
        if (set.has(c)) return c;
      }
      // loose match (trim)
      for (const c of candidates){
        const found = fields.find(f => String(f).trim() === String(c).trim());
        if (found) return found;
      }
      return null;
    }

    function buildColumnMap(fields){
      const mapped = {};
      for (const key of Object.keys(COLCAND)){
        mapped[key] = detectFirst(fields, COLCAND[key]);
      }
      COL = mapped;
    }

    function parseDateMaybe(s) {
      if (!s) return null;
      const d1 = new Date(s);
      if (!isNaN(d1)) return d1;

      const parts = String(s).split(" ");
      const datePart = parts[0];
      const timePart = parts[1];
      if (!datePart) return null;

      let nums = datePart.split(/[\/\-\.]/).map(x => parseInt(x, 10));
      if (nums.length !== 3) return null;

      let day, month, year;
      if (nums[0] > 12) { day = nums[0]; month = nums[1]; year = nums[2]; }
      else { month = nums[0]; day = nums[1]; year = nums[2]; }

      const [hh, mm] = (timePart || "00:00").split(":").map(x => parseInt(x, 10));
      const d = new Date(year, (month || 1) - 1, day || 1, hh || 0, mm || 0);
      return isNaN(d) ? null : d;
    }

    function safeNum(v) {
      const n = Number(String(v || "").replace(/,/g,""));
      return Number.isFinite(n) ? n : 0;
    }

    function formatDate(d) {
      if (!d) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function normText(s){
      return String(s || "").toLowerCase();
    }

    function keywordFiltered(rows){
      const kw = normText(searchBox.value).trim();
      if (!kw) return rows;
      return rows.filter(r => {
        const t = normText(COL.title ? r[COL.title] : "");
        const link = normText(COL.permalink ? r[COL.permalink] : "");
        return t.includes(kw) || link.includes(kw);
      });
    }

    function currentFilteredRows() {
      const yearVal = yearFilter.value;
      let rows = rawRows.filter(r => {
        const d = r.__date;
        if (yearVal !== "all") {
          if (!d || String(d.getFullYear()) !== yearVal) return false;
        }
        if (monthVal !== "all") {
          if (!d || d.getMonth() !== Number(monthVal)) return false;
        }
        return true;
      });
      rows = keywordFiltered(rows);
      return rows;
    }

    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ: ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ + ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô ‡πÅ‡∏ï‡πà "‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    function rowsForMoMAndPie(){
      const yearVal = yearFilter.value;
      let rows = rawRows.filter(r => {
        const d = r.__date;
        if (yearVal !== "all") {
          if (!d || String(d.getFullYear()) !== yearVal) return false;
        }
        return true;
      });
      rows = keywordFiltered(rows);
      return rows;
    }

    function updateKPIs(rows) {
      const count = rows.length;
      const totalEng = rows.reduce((a,r)=>a + (r.__engagement || 0), 0);
      const avgEng = count ? (totalEng / count) : 0;

      let top = null;
      for (const r of rows) {
        if (!top || (r.__engagement || 0) > (top.__engagement || 0)) top = r;
      }

      document.getElementById("kpiPosts").textContent = count.toLocaleString("th-TH");
      document.getElementById("kpiAvgEng").textContent = avgEng.toFixed(1);
      document.getElementById("kpiTopEng").textContent = top ? (top.__engagement || 0).toLocaleString("th-TH") : "-";
    }

    function rebuildTable(rows) {
      const data = rows.map(r => {
        const title = COL.title ? (r[COL.title] || "") : "";
        const url = COL.permalink ? (r[COL.permalink] || "") : "";
        return [
          formatDate(r.__date),
          title,
          r.__like,
          r.__share,
          r.__engagement,
          r.__reach,
          r.__views,
          url ? `<a href="${url}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå</a>` : ""
        ];
      });

      if (table) {
        table.clear();
        table.rows.add(data);
        table.draw();
      } else {
        table = new DataTable("#postsTable", {
          data,
          columns: [
            { title: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" },
            { title: "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏û‡∏™‡∏ï‡πå" },
            { title: "Like" },
            { title: "Share" },
            { title: "Engagement" },
            { title: "Reach" },
            { title: "Views" },
            { title: "Link", orderable: false }
          ],
          pageLength: 25,
          order: [[4, "desc"]],
          language: {
            search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á:",
            lengthMenu: "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡πÅ‡∏ñ‡∏ß",
            info: "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_ ‡πÅ‡∏ñ‡∏ß",
            paginate: { first: "‡πÅ‡∏£‡∏Å", last: "‡∏ó‡πâ‡∏≤‡∏¢", next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ", previous: "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤" },
            emptyTable: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
          }
        });
      }
    }

    // ---------- Monthly aggregation ----------
    const MONTH_LABELS = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];

    function getMonthlyAgg(rows){
      const agg = Array.from({length:12},()=>({
        posts:0, views:0, reach:0, impressions:0, like:0, share:0, comment:0, engage:0
      }));

      for (const r of rows){
        const d = r.__date; if(!d) continue;
        const m = d.getMonth();
        agg[m].posts += 1;
        agg[m].views += r.__views || 0;
        agg[m].reach += r.__reach || 0;
        agg[m].impressions += (r.__impressions || 0);
        agg[m].like += r.__like || 0;
        agg[m].share += r.__share || 0;
        agg[m].comment += r.__comment || 0;
        agg[m].engage += r.__engageFull || 0;
      }
      return agg;
    }

    function getDailyAgg(rows, monthIndex){
      // rows should already be filtered by year + keyword
      const inMonth = rows.filter(r => r.__date && r.__date.getMonth() === monthIndex);
      let maxDay = 0;
      const yv = yearFilter.value;
      if (yv !== 'all'){
        const y = Number(yv);
        maxDay = new Date(y, monthIndex + 1, 0).getDate();
      } else {
        // across years: use max day found in data; fallback 31
        maxDay = inMonth.reduce((m,r)=>Math.max(m, r.__date.getDate()), 0) || 31;
      }

      const agg = Array.from({length:maxDay}, ()=>({
        posts:0, views:0, reach:0, impressions:0, like:0, share:0, comment:0, engage:0
      }));

      for (const r of inMonth){
        const d = r.__date;
        const di = d.getDate() - 1;
        if (di < 0 || di >= maxDay) continue;
        agg[di].posts += 1;
        agg[di].views += r.__views || 0;
        agg[di].reach += r.__reach || 0;
        agg[di].impressions += (r.__impressions || 0);
        agg[di].like += r.__like || 0;
        agg[di].share += r.__share || 0;
        agg[di].comment += r.__comment || 0;
        agg[di].engage += r.__engageFull || 0;
      }

      const labels = Array.from({length:maxDay}, (_,i)=>String(i+1).padStart(2,'0'));
      return { labels, agg };
    }

    function monthColors(alpha=0.65){
      // 12 ‡∏™‡∏µ‡πÅ‡∏ö‡∏ö‡πÑ‡∏•‡πà‡πÇ‡∏ó‡∏ô (‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ö‡∏ô Dark)
      const cols = [];
      for(let i=0;i<12;i++){
        const hue = Math.round((i*360)/12);
        cols.push(`hsla(${hue}, 75%, 55%, ${alpha})`);
      }
      return cols;
    }

    function destroyCharts(){
      if (momChart){ momChart.destroy(); momChart = null; }
      if (pieContent){ pieContent.destroy(); pieContent = null; }
      if (pieImpr){ pieImpr.destroy(); pieImpr = null; }
      if (pieEng){ pieEng.destroy(); pieEng = null; }
    }

    function chartDefaults(){
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: "#e6edf7" } },
          tooltip: { titleColor:"#e6edf7", bodyColor:"#e6edf7" }
        },
        scales: {
          x: { ticks: { color:"#9fb0c6" }, grid: { color:"rgba(35,48,67,0.35)" } },
          y: { ticks: { color:"#9fb0c6" }, grid: { color:"rgba(35,48,67,0.35)" } }
        }
      };
    }

    function renderCharts(){
      const baseRows = rowsForMoMAndPie();

      // ===== Report Chart (MoM or Daily) =====
      if (monthlyChartsEl.style.display !== "none"){
        const ctx = document.getElementById("momChart");
        if (momChart) momChart.destroy();

        let labels = [];
        let series = null;

        if (monthVal === "all"){
          // Month-to-month
          const agg = getMonthlyAgg(baseRows);
          labels = MONTH_LABELS;
          series = {
            posts: agg.map(a=>a.posts),
            views: agg.map(a=>a.views),
            like: agg.map(a=>a.like),
            share: agg.map(a=>a.share),
            comment: agg.map(a=>a.comment)
          };
          const mt = document.getElementById('momTitle');
          if (mt) mt.textContent = '‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ï‡∏≤‡∏°‡∏õ‡∏µ + ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô) ‚Äî Posts / Views / Like / Share / Comment';
        } else {
          // Daily within selected month
          const mi = Number(monthVal);
          const daily = getDailyAgg(baseRows, mi);
          labels = daily.labels;
          const agg = daily.agg;
          series = {
            posts: agg.map(a=>a.posts),
            views: agg.map(a=>a.views),
            like: agg.map(a=>a.like),
            share: agg.map(a=>a.share),
            comment: agg.map(a=>a.comment)
          };
          const mt = document.getElementById('momTitle');
          if (mt) mt.textContent = `‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${MONTH_LABELS[mi]} (‡∏ï‡∏≤‡∏°‡∏õ‡∏µ + ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô) ‚Äî Posts / Views / Like / Share / Comment`;
        }

        const ds = [
          { label:"Posts", data: series.posts, yAxisID:"y", backgroundColor:"rgba(110,168,255,0.55)", borderColor:"rgba(110,168,255,0.9)", borderWidth:1 },
          { label:"Like", data: series.like, yAxisID:"y", backgroundColor:"rgba(94,234,212,0.45)", borderColor:"rgba(94,234,212,0.9)", borderWidth:1 },
          { label:"Share", data: series.share, yAxisID:"y", backgroundColor:"rgba(250,204,21,0.45)", borderColor:"rgba(250,204,21,0.9)", borderWidth:1 },
          { label:"Comment", data: series.comment, yAxisID:"y", backgroundColor:"rgba(244,114,182,0.45)", borderColor:"rgba(244,114,182,0.9)", borderWidth:1 },
          { label:"Views", data: series.views, yAxisID:"y1", type:"line", tension:0.25, borderColor:"rgba(147,197,253,0.95)", pointRadius:2 }
        ];

        momChart = new Chart(ctx, {
          type: "bar",
          data: { labels, datasets: ds },
          options: {
            ...chartDefaults(),
            plugins: {
              ...chartDefaults().plugins,
              tooltip: {
                callbacks: {
                  afterBody: (items)=>{
                    const idx = items?.[0]?.dataIndex ?? 0;
                    const p = (series.posts[idx] || 0);
                    const v = (series.views[idx] || 0);
                    return [`Posts: ${p.toLocaleString('th-TH')}`, `Views: ${v.toLocaleString('th-TH')}`];
                  }
                }
              }
            },
            scales: {
              x: { ticks: { color:"#9fb0c6" }, grid: { color:"rgba(35,48,67,0.25)" } },
              y: { beginAtZero:true, ticks:{ color:"#9fb0c6" }, grid:{ color:"rgba(35,48,67,0.35)" } },
              y1: { beginAtZero:true, position:"right", ticks:{ color:"#9fb0c6" }, grid:{ drawOnChartArea:false } }
            }
          }
        });
      }

      // Pie charts
      if (pieChartsEl.style.display !== "none"){
        // Pie ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏õ‡∏µ‡πÄ‡∏™‡∏°‡∏≠ (‡∏õ‡∏µ + ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô) ‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        const yearAgg = getMonthlyAgg(baseRows);
        const colors = monthColors(0.72);
        const posts = yearAgg.map(a=>a.posts);
        const impr = yearAgg.map(a=>{
          // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ impressions ‡πÉ‡∏ä‡πâ impressions ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô fallback reach
          const v = a.impressions || 0;
          return v > 0 ? v : a.reach;
        });
        const engage = yearAgg.map(a=>a.engage);

        const avgPerPost = (vals, postsArr, idx) => {
          const p = postsArr[idx] || 0;
          return p ? (vals[idx] / p) : 0;
        };

        const makePie = (canvasId, values, postsArr, titleLabel)=>{
          const ctx = document.getElementById(canvasId);
          return new Chart(ctx, {
            type:"pie",
            data:{ labels: MONTH_LABELS, datasets:[{ data: values, backgroundColor: colors }] },
            options:{
              responsive:true,
              plugins:{
                legend:{ labels:{ color:"#e6edf7" } },
                tooltip:{
                  callbacks:{
                    label: (ctx)=>{
                      const idx = ctx.dataIndex;
                      const val = values[idx] || 0;
                      const p = postsArr[idx] || 0;
                      const avg = avgPerPost(values, postsArr, idx);
                      const parts = [
                        `${ctx.label}: ${val.toLocaleString("th-TH")}`
                      ];
                      if (titleLabel !== "Content"){
                        parts.push(`Avg/Post: ${avg.toFixed(1)}`);
                      }
                      parts.push(`Posts: ${p.toLocaleString("th-TH")}`);
                      return parts;
                    }
                  }
                }
              }
            }
          });
        };

        if (pieContent) pieContent.destroy();
        if (pieImpr) pieImpr.destroy();
        if (pieEng) pieEng.destroy();

        pieContent = makePie("pieContent", posts, posts, "Content");
        pieImpr = makePie("pieImpr", impr, posts, "Impression");
        pieEng = makePie("pieEng", engage, posts, "Engage");
      }
    }

    function applyFilters() {
      const rows = currentFilteredRows();
      updateKPIs(rows);
      rebuildTable(rows);

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏° filter (‡∏õ‡∏µ + ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô)
      if (monthlyChartsEl.style.display !== "none" || pieChartsEl.style.display !== "none"){
        renderCharts();
      }
    }

    function normalizeRows(rows) {
      return rows.map(r => {
        const d = COL.publishedAt ? parseDateMaybe(r[COL.publishedAt]) : null;
        const like = COL.like ? safeNum(r[COL.like]) : 0;
        const share = COL.share ? safeNum(r[COL.share]) : 0;
        const reach = COL.reach ? safeNum(r[COL.reach]) : 0;
        const views = COL.views ? safeNum(r[COL.views]) : 0;
        const comment = COL.comment ? safeNum(r[COL.comment]) : 0;
        const impressions = COL.impressions ? safeNum(r[COL.impressions]) : 0;

        r.__date = d;
        r.__like = like;
        r.__share = share;
        r.__comment = comment;
        r.__engagement = like + share; // KPI ‡πÄ‡∏î‡∏¥‡∏° (Like+Share)
        r.__engageFull = like + share + comment; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü Engage
        r.__reach = reach;
        r.__views = views;
        r.__impressions = impressions;
        return r;
      });
    }

    // ---------- Events ----------
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          const fields = res.meta?.fields || (res.data?.[0] ? Object.keys(res.data[0]) : []);
          buildColumnMap(fields);

          rawRows = normalizeRows(res.data || []);
          applyFilters();
        },
        error: (err) => {
          alert("‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
        }
      });
    });

    // Month tabs
    monthTabs.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-month]");
      if (!btn) return;
      monthVal = btn.dataset.month || "all";
      monthTabs.querySelectorAll("button[data-month]").forEach(b => {
        b.classList.toggle("active", b === btn);
      });
      applyFilters();
    });

    yearFilter.addEventListener("change", applyFilters);
    searchBox.addEventListener("input", applyFilters);

    resetBtn.addEventListener("click", () => {
      yearFilter.value = "2025";
      monthVal = "all";
      monthTabs.querySelectorAll("button[data-month]").forEach(b => {
        b.classList.toggle("active", b.dataset.month === "all");
      });
      searchBox.value = "";
      applyFilters();
    });

    compareBtn.addEventListener("click", () => {
      const isOpen = monthlyChartsEl.style.display !== "none";
      monthlyChartsEl.style.display = isOpen ? "none" : "block";
      if (!isOpen) renderCharts();
    });

    pieBtn.addEventListener("click", () => {
      const isOpen = pieChartsEl.style.display !== "none";
      pieChartsEl.style.display = isOpen ? "none" : "block";
      if (!isOpen) renderCharts();
    });
  </script>
</body>
</html>
